<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"dybeta2021.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="The SVI is simply a function (empirically fit to the data) which given a maturity and a strike price \(K\), computes a BS implied volatility \(\sigma\). Once you have that implied volatility you can p">
<meta property="og:type" content="article">
<meta property="og:title" content="Stochastic Volatility Inspired">
<meta property="og:url" content="https://dybeta2021.github.io/2021/07/13/svi/index.html">
<meta property="og:site_name" content="子非鱼">
<meta property="og:description" content="The SVI is simply a function (empirically fit to the data) which given a maturity and a strike price \(K\), computes a BS implied volatility \(\sigma\). Once you have that implied volatility you can p">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://dybeta2021.github.io/2021/07/13/svi/fig1.png">
<meta property="og:image" content="https://dybeta2021.github.io/2021/07/13/svi/svi-linear.png">
<meta property="article:published_time" content="2021-07-13T06:01:37.000Z">
<meta property="article:modified_time" content="2021-07-13T06:01:37.000Z">
<meta property="article:author" content="稻草人">
<meta property="article:tag" content="ivs">
<meta property="article:tag" content="svi">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://dybeta2021.github.io/2021/07/13/svi/fig1.png">

<link rel="canonical" href="https://dybeta2021.github.io/2021/07/13/svi/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Stochastic Volatility Inspired | 子非鱼</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">子非鱼</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/dybeta2021" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dybeta2021.github.io/2021/07/13/svi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="稻草人">
      <meta itemprop="description" content="风物长宜放眼量">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="子非鱼">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Stochastic Volatility Inspired
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-13 14:01:37" itemprop="dateCreated datePublished" datetime="2021-07-13T14:01:37+08:00">2021-07-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Option/" itemprop="url" rel="index"><span itemprop="name">Option</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>The SVI is simply a function (empirically fit to the data) which
given a maturity and a strike price <span
class="math inline">\(K\)</span>, computes a BS implied volatility <span
class="math inline">\(\sigma\)</span>. Once you have that implied
volatility you can plug it into a Black Scholes routine which can
compute the BS price and the Black Scholes Greeks. SVI/SVI-JW are used
to describe <strong>one slice</strong> (single tenor) at the time;
<strong>Surface SVI</strong> (SSVI) is used to fit the whole surface
(multiple tenors).</p>
<span id="more"></span>
<h2 id="the-svi-parameterization">The SVI parameterization</h2>
<p>Implied variance is always linear in <span
class="math inline">\(k\)</span> as <span class="math inline">\(|k| \to
+\infty\)</span>. If we want a parameterization of the implied variance
surface, it needs to be linear in the wings and it needs to be curved in
the middle as many conventional parameterizations of the volatility
surface are quadratic for example.</p>
<p><span class="math display">\[
{\rm var}(k; a,b,\sigma,\rho, m) = a+b(\rho(k-m) +
\sqrt{(k-m)^2+\sigma^2})
\]</span></p>
<ul>
<li><span class="math inline">\(a\)</span> gives the overall level of
variance，<span
class="math inline">\(a\)</span>增加时，波动率曲线整体向上平移。</li>
<li><span class="math inline">\(b\)</span> gives the angle between the
left and right asymptotes，<span
class="math inline">\(b\)</span>增加时两翼之间的夹角变小 。</li>
<li><span class="math inline">\(\sigma\)</span> determines how smooth
the vertex is, reduces ATM curvature of the smile</li>
<li><span class="math inline">\(\rho\)</span> determines the orientation
of the graph，rho负右偏，rho正左偏</li>
<li>changing <span class="math inline">\(m\)</span> translates the
graph，m增加，右移</li>
<li>SVI线性模型拟合方差，对iv-slice实质上是亚线性模型。</li>
</ul>
<h2 id="slopes-and-minimum">Slopes and minimum</h2>
<p>The left and right asymptotes are respectively <span
class="math display">\[\begin{equation}
\begin{aligned}
\sigma_{L}^2(x) &amp;= a - b(1-\rho)(x-m)\\
\sigma_{R}^2 &amp;= a + b(1+\rho)(x-m)
\end{aligned}
\end{equation}\]</span></p>
<p><img src="fig1.png" width="75%" height="75%" title="fig1" alt="fig1"/></p>
<ul>
<li>Variance increases linearly with |k| for k very positive or very
negative</li>
<li>Intuition is that the more out-of-the-money an option is, the more
volatility convexity it has.</li>
</ul>
<p>在实际应用中SVI表达式对极大极小值线性近似几乎没有实际影响，设<span
class="math inline">\(S=3\)</span>, <span
class="math inline">\(K=range(2, 4,
0.1)\)</span>则moneyness对应的SVI拟合曲线如下图，并未达到极端值区间。其中left和right为左右渐近线。</p>
<p><img src="svi-linear.png" width="75%" height="75%" title="svi-linear" alt="svi-linear"/></p>
<h2 id="arbitrage-free-conditions">Arbitrage-Free Conditions</h2>
<h3 id="vertical-spread-arbitrage-free">Vertical Spread
Arbitrage-Free</h3>
<p><span class="math display">\[
b(1+|\rho|) \leq \frac{4}{T}
\]</span></p>
<h3 id="calendar-spread-arbitrage-free">Calendar Spread
Arbitrage-Free</h3>
<p>Keeping the moneyness constant, option prices are non-decreasing in
time to expiration. Let <span class="math inline">\(\omega_t =
\sigma_{BS}(k,t)^2t\)</span> for fixed <span
class="math inline">\(k\)</span>, we must have the total implied
variance non-decreasing with respect to time to expiration.</p>
<h2 id="quasi-explicit-calibration">Quasi-Explicit Calibration</h2>
<p>Quasi-Explicit
Calibration通过两步法循环优化将对5个变量损失函数的优化过程降维到2个变量，
提高了校正的速度和参数稳定性。 使用整体方差<span
class="math inline">\({\rm tv} = \sigma_{\rm implied} ^2 T\)</span>
替换方差<span class="math inline">\({\rm var}\)</span> <span
class="math display">\[
{\rm var} \cdot T = (a+b(\rho(k-m) + \sqrt{(k-m)^2+\sigma^2})) \cdot T
\]</span> <span class="math display">\[
{\rm tv} = a T+b T(\rho(k-m) + \sqrt{(k-m)^2+\sigma^2})
\]</span> 令<span class="math inline">\(y = \frac{k-m}{\sigma}\)</span>
则原始的SVI模型转换为 <span class="math display">\[
{\rm tv} = aT+b\sigma T(\rho y + \sqrt{y^2+1})
\]</span> 令 <span class="math display">\[
c = b\sigma T\\
d = \rho b \sigma T\\
\widetilde{a} = aT
\]</span> 则 <span class="math display">\[
{\rm tv} =\widetilde v(y) =\widetilde{a} + dy+c\sqrt{y^2+1}
\]</span> 校准的目标函数从5个参数转换为2个参数<span
class="math inline">\(m\)</span>和<span
class="math inline">\(\sigma\)</span>的损失函数 <span
class="math display">\[
f_{y,{\rm tv} } (c,d,\widetilde{a}) = \sum((\widetilde a + dy +
c\sqrt{y^2+1}) - \widetilde v(y))^2
\]</span> 即最优化 <span class="math display">\[
(P_{m,\sigma}) = {\rm min}_{(c,d,\widetilde{a}) \in D} f_{y,{\rm tv} }
(c,d,\widetilde{a})
\]</span> 函数<span class="math inline">\(f_{y,{\rm tv} }
(c,d,\widetilde{a})\)</span>是固定参数<span
class="math inline">\(m\)</span>和<span
class="math inline">\(\sigma\)</span>对应<span
class="math inline">\(c,d,a\)</span>的损失函数 <span
class="math display">\[
f_{y,{\rm tv} } (c,d,\widetilde{a})=\sum^{n}_{i=1} (\widetilde{a} + dy_i
+ c\sqrt{y^2+1}- v(y))^2
\]</span> 约束域<span class="math inline">\(D\)</span>为 <span
class="math display">\[
0\leq c\leq 4\sigma\\
\]</span> <span class="math display">\[
|d|\leq c \ {\rm and} \ |d|\leq 4\sigma - c\\
\]</span> <span class="math display">\[
0\leq \widetilde{a} \leq {\rm max } \{ {\widetilde v_i} \}
\]</span>
至此，SVI模型的优化过程变成一个两步优化过程，外层循环使用Nelder-Mead估算<span
class="math inline">\(m\)</span>和<span
class="math inline">\(\sigma\)</span>两个参数，内层使用梯度下降法令梯度算子为0直接获得<span
class="math inline">\(a,b,
\rho\)</span>三个参数。对于超出边界的情况使用凸优化域边界值为三个未知变量<span
class="math inline">\(a,d,c\)</span>赋值，计算在边界条件时候的loss函数，选择loss最小的一组<span
class="math inline">\(a,d,c\)</span>值作为<span
class="math inline">\(m,\sigma\)</span>在网格参数扫描对应参数的loss。</p>
<p><strong>优化算法</strong></p>
<ul>
<li>step-1 参数<span class="math inline">\(m,\sigma\)</span>对应的<span
class="math inline">\(c,d,a\)</span>直接解线性方程组，检测函数<code>acceptable</code>判断是否在域内，如果<span
class="math inline">\(c,d,a\)</span>参数取值在域内直接采用。
对变量为<span class="math inline">\(a,b,
\rho\)</span>的方程组使用GBD算法优化的最小值在梯度<span
class="math inline">\(\nabla f =0\)</span>的位置，即 <span
class="math display">\[
\frac{1}{2}\nabla f(c,d,\widetilde a) = A \begin{Bmatrix} c \\ d \\a
\end{Bmatrix} - b = 0
\]</span></li>
</ul>
<p><span class="math display">\[
A= \begin{Bmatrix} n+Y_2 &amp;&amp; Y_4 &amp;&amp; Y_3 \\ Y_4 &amp;&amp;
Y_2 &amp;&amp; Y_1 \\ Y_3 &amp;&amp; Y_1 &amp;&amp; n \end{Bmatrix}
\]</span></p>
<p><span class="math display">\[
b =\begin{Bmatrix} vY_2\\ vY \\v \end{Bmatrix}
\]</span></p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
Y_1 &amp;= \sum_i y_i\\
Y_2 &amp;= \sum_i y_i^2 \\
Y_3 &amp;= \sum_i \sqrt{y_i^2+1}\\
Y_4 &amp;= \sum_i y_i \sqrt{y_i^2+1}\\
\end{aligned}
\end{equation}\]</span></p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
vY_2 &amp;= \sum_i \widetilde v_i \sqrt{y_i^2+1}\\
vY &amp;= \sum_i \widetilde v_i y_i\\
v &amp;= \sum_i \widetilde v_i \\
\end{aligned}
\end{equation}\]</span></p>
<p>程序实现中修改算法为 <span class="math display">\[
\begin{Bmatrix} y_5 &amp;&amp; y_4 &amp;&amp; y_3 \\ y_4 &amp;&amp; y_2
&amp;&amp; y_1 \\ y_3 &amp;&amp; y_1 &amp;&amp; w \end{Bmatrix}
\begin{Bmatrix} c \\ d \\a \end{Bmatrix} = \begin{Bmatrix} vy_2\\ vY \\v
\end{Bmatrix}
\]</span></p>
<ul>
<li>使用mean取代sum消除不同batch-size可能导致的数量级影响</li>
<li>使用 vega /
vega.max()的winsorize方式对loss-function中不同合约添加权重</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vega /= vega.<span class="built_in">max</span>()  <span class="comment"># winsorize</span></span><br><span class="line">w = vega.mean()  <span class="comment"># weight replace n, n = tiv.shape[0]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># scale</span></span><br><span class="line">y = (k - m) / sigma</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2020-04-10 sum -&gt; mean 消除batch-size 数量级对epsilon影响,</span></span><br><span class="line"><span class="comment"># vega adjusted the weight of tail contracts in loss function</span></span><br><span class="line">y1 = (vega * y).mean()</span><br><span class="line">y2 = (vega * y * y).mean()</span><br><span class="line">y3 = (vega * sqrt(y * y + <span class="number">1</span>)).mean()</span><br><span class="line">y4 = (vega * y * sqrt(y * y + <span class="number">1</span>)).mean()</span><br><span class="line">y5 = (vega * (y * y + <span class="number">1</span>)).mean()</span><br><span class="line"></span><br><span class="line">vy2 = (vega * tiv * sqrt(y * y + <span class="number">1</span>)).mean()</span><br><span class="line">vy = (vega * tiv * y).mean()</span><br><span class="line">v = (vega * tiv).mean()</span><br></pre></td></tr></table></figure>
<ul>
<li>step-2
如果不在域内，使用边界条件的极值计算。分别假设一个变量取极值、两个变量取极值的loss-function，选择最小的loss对应的<span
class="math inline">\(c,d,a\)</span> 和loss作为<span
class="math inline">\(m,\sigma\)</span>对应的最优化。 例如对<span
class="math inline">\(a = 0\)</span> 约束域修改对比</li>
</ul>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
0 \leq c \leq 4\sigma \\
|d| \leq c \ and \ |d| \leq4\sigma - c \\
0 \leq \widetilde a \leq max_{i}\{\widetilde v_i \} \\
\end{aligned}
\end{equation}\]</span></p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
0 \leq c \leq 4\sigma  \\
|d| \leq c \ and \ |d| \leq4\sigma - c  \\
a = 0\\
\end{aligned}
\end{equation}\]</span></p>
<p><span class="math display">\[
\begin{Bmatrix} y_5 &amp;&amp; y_4 &amp;&amp; y_3 \\ y_4 &amp;&amp; y_2
&amp;&amp; y_1 \\ y_3 &amp;&amp; y_1 &amp;&amp; w \end{Bmatrix}
\begin{Bmatrix} c \\ d \\a \end{Bmatrix} = \begin{Bmatrix} vy_2\\ vY \\v
\end{Bmatrix}
\]</span></p>
<p><span class="math display">\[
\begin{Bmatrix} y_5 &amp;&amp; y_4 &amp;&amp; y_3 \\ y_4 &amp;&amp; y_2
&amp;&amp; y_1 \\ 0 &amp;&amp; 0 &amp;&amp; 1 \end{Bmatrix}
\begin{Bmatrix} c \\ d \\a \end{Bmatrix} = \begin{Bmatrix} vy_2\\ vY \\0
\end{Bmatrix}
\]</span></p>
<ul>
<li><strong>注</strong> 对<span
class="math inline">\(c,d,a\)</span>取边界条件进行参数扫描的时候 <span
class="math inline">\(c = 0, c=4\sigma\)</span> 隐含约束<span
class="math inline">\(d = 0\)</span> 。</li>
</ul>
<h3 id="梯度下降法展开">梯度下降法展开</h3>
<p>目标函数 <span class="math display">\[
f_{y,{\rm tv} } (c,d,\widetilde{a})=\sum^{n}_{i=1} (\widetilde{a} + dy_i
+ c\sqrt{y_i^2+1}- v(y_i))^2
\]</span> 调整符号和顺序 <span class="math display">\[
f (c,d,a)=\sum^{n}_{i=1} (\sqrt{y_i^2+1}\cdot c + y_i\cdot d  +
\widetilde{a}- \widetilde{v}_i)^2
\]</span></p>
<p>梯度下降，凸优化损失函数极值在梯度算子为0的位置<span
class="math inline">\(\nabla f =0\)</span> 对参数<span
class="math inline">\(c\)</span></p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
\frac{\partial f}{\partial c} &amp;= \sum 2 \sqrt{y_i^2+1}
(\sqrt{y_i^2+1}\cdot c + y_i\cdot d  + \widetilde{a}- \widetilde{v}_i)
\\
&amp;=\sum 2((y_i^2+1)c + \sqrt{y_i^2+1} y_i d + \sqrt{y_i^2+1}a) -
2\sum \sqrt{y_i^2+1} \cdot \widetilde{v}_i\\
&amp;= 0
\end{aligned}
\end{equation}\]</span></p>
<p>即 <span class="math display">\[
\sum(y_i^2+1) \cdot c + \sum\sqrt{y_i^2+1} y_i \cdot d + \sum
\sqrt{y_i^2+1} \cdot a - \sum \sqrt{y_i^2+1} \cdot \widetilde{v}_i= 0
\]</span></p>
<p>对参数<span class="math inline">\(d\)</span> <span
class="math display">\[
\frac{\partial f}{\partial d} = \sum 2 y_i (\sqrt{y_i^2+1}\cdot c +
y_i\cdot d  + \widetilde{a}- \widetilde{v}_i) = 0
\]</span> 即 <span class="math display">\[
\sum y_i \sqrt{y_i^2+1} \cdot c + \sum y_i^2 \cdot d +\sum y_i \cdot a -
\sum y_i \cdot \widetilde{v}_i = 0
\]</span></p>
<p>对参数<span class="math inline">\(a\)</span> <span
class="math display">\[
\frac{\partial f}{\partial a} = \sum 2  (\sqrt{y^2+1}\cdot c + y_i\cdot
d  + \widetilde{a}- \widetilde{v}_i) = 0
\]</span> 即 <span class="math display">\[
\sum \sqrt{y^2+1}\cdot c + \sum  y_i\cdot d  + \sum 1 \cdot
\widetilde{a}- \sum 1 \cdot \widetilde{v}_i = 0
\]</span></p>
<p>即求解如下行列式 <span class="math display">\[
\begin{Bmatrix} n+Y_2 &amp;&amp; Y_4 &amp;&amp; Y_3 \\ Y_4 &amp;&amp;
Y_2 &amp;&amp; Y_1 \\ Y_3 &amp;&amp; Y_1 &amp;&amp; n \end{Bmatrix}
\begin{Bmatrix} c \\ d \\ \widetilde{a} \end{Bmatrix} = \begin{Bmatrix}
vY_2\\ vY \\v \end{Bmatrix}
\]</span></p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
Y_1 &amp;= \sum_i y_i\\
Y_2 &amp;= \sum_i y_i^2 \\
Y_3 &amp;= \sum_i \sqrt{y_i^2+1}\\
Y_4 &amp;= \sum_i y_i \sqrt{y_i^2+1}\\
\end{aligned}
\end{equation}\]</span></p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
vY_2 &amp;= \sum_i \widetilde v_i \sqrt{y_i^2+1}\\
vY &amp;= \sum_i \widetilde v_i y_i\\
v &amp;= \sum_i \widetilde v_i \\
\end{aligned}
\end{equation}\]</span></p>
<h2 id="the-svi-jump-wings-svi-jw-parameterization">The SVI Jump-Wings
(SVI-JW) parameterization</h2>
<blockquote>
<p>Neither the raw SVI nor the natural SVI parameterizations are
intuitive to traders in the sense that a trader cannot be expected to
carry around the typical value of these parameters in his head.
Moreover, there is no reason to expect these parameters to be
particularly stable. The SVI-Jump-Wings (SVI-JW) parameterization of the
implied variance v (rather than the implied total variance w) was
inspired by a similar parameterization attributed to Tim Klassen, then
at Goldman Sachs. For a given time to expiry <span
class="math inline">\(t &gt;0\)</span> and a parameter set <span
class="math inline">\(\xi_J:=\{v_t,\psi_t,p_t,c_t,\tilde{v_t}\}\)</span>
the SVI-JW parametrization is given in raw SVI parameters:</p>
</blockquote>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
v_t &amp;= \frac{a+b\left(-\rho m+\sqrt{m^2+\sigma^2}\right)}{t}\\
\psi_t
&amp;=\frac{b}{2\sqrt{w_t}}\left(-\frac{m}{\sqrt{m^2+\sigma^2}}+\rho\right)\\
p_t &amp;= \frac{b}{\sqrt{w_t}}(1-\rho)\\
c_t &amp;= \frac{b}{\sqrt{w_t}}(1+\rho)\\
\tilde{v_t} &amp;= \frac{1}{t}\left(a+b\sigma\sqrt{1-\rho^2}\right)\\
\end{aligned}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(w_t:=v_tt\)</span>.</p>
<ul>
<li><span class="math inline">\(v_t\)</span> gives the ATM
variance;</li>
<li><span class="math inline">\(\psi_t\)</span> gives the ATM skew;</li>
<li><span class="math inline">\(p_t\)</span> gives the slope of the left
(put) wing;</li>
<li><span class="math inline">\(c_t\)</span> gives the slope of the
right (call) wing;</li>
<li><span class="math inline">\(\tilde{v_t}\)</span> is the minimum
implied variance.</li>
</ul>
<h2 id="reference">Reference</h2>
<ul>
<li><a target="_blank" rel="noopener" href="http://faculty.baruch.cuny.edu/jgatheral/madrid2004.pdf">A
parsimonious arbitrage-free implied volatility parameterization with
application to the valuation of volatility derivatives</a></li>
<li><a
target="_blank" rel="noopener" href="https://github.com/bramjochems/MyExcelLib/blob/master/BJExcelLib/Finance.SVI.fs">MyExcelLib</a></li>
<li><a
target="_blank" rel="noopener" href="https://github.com/remis-thoughts/svi-zeliade">svi-zeliade</a></li>
<li><a
target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36902908">理解梯度下降法</a></li>
<li><a
target="_blank" rel="noopener" href="https://www.cnblogs.com/pinard/p/5970503.html">梯度下降（Gradient
Descent）小结</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/38128785/">最小二乘法（least
sqaure method）</a></li>
<li><a
target="_blank" rel="noopener" href="https://zeliade.com/wp-content/uploads/whitepapers/zwp-0005-SVICalibration.pdf">Quasi-Explicit
Calibration of Gatheral’s SVI model</a></li>
<li><a
target="_blank" rel="noopener" href="https://mfe.baruch.cuny.edu/wp-content/uploads/2013/01/OsakaSVI2012.pdf">Arbitrage-free
SVI volatility surfaces</a></li>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1204.0646.pdf">Arbitrage-free SVI
volatility surfaces</a></li>
<li><a
target="_blank" rel="noopener" href="https://www.math.kth.se/matstat/seminarier/reports/M-exjobb14/140909.pdf">The
SVI implied volatility model and its calibration</a></li>
<li><a
target="_blank" rel="noopener" href="https://github.com/wangys96/SVI-Volatility-Surface-Calibration/blob/master/svi.py">SVI-Volatility-Surface-Calibration</a></li>
</ul>
<h2 id="quasi-explicit-calibration-code">Quasi-Explicit Calibration
Code</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2020/4/3 12:59 PM</span></span><br><span class="line"><span class="comment"># @Author  : 稻草人</span></span><br><span class="line"><span class="comment"># @contact : aidabloc@163.com</span></span><br><span class="line"><span class="comment"># @File    : svi.py</span></span><br><span class="line"><span class="comment"># @Desc    :</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> (power, sign, maximum, <span class="built_in">round</span>, argmin, sqrt, <span class="built_in">abs</span>, array, clip, minimum, nan_to_num, ndarray)</span><br><span class="line"><span class="keyword">from</span> numpy.linalg <span class="keyword">import</span> solve</span><br><span class="line"><span class="keyword">from</span> scipy.optimize <span class="keyword">import</span> minimize</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseSVI</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">svi_raw</span>(<span class="params">k, a, b, m, rho, sigma</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;raw SVI parameterization</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param k: log-moneyness at which to evaluate the total implied variance</span></span><br><span class="line"><span class="string">        :param a: level of variance</span></span><br><span class="line"><span class="string">        :param b: gives the angle between the left and right asymptotes</span></span><br><span class="line"><span class="string">        :param m: translates smile to right</span></span><br><span class="line"><span class="string">        :param rho: counter-clockwise rotation of smile</span></span><br><span class="line"><span class="string">        :param sigma: determines how smooth the vertex is，reduces ATM curvature of the smile</span></span><br><span class="line"><span class="string">        :return: estimated total variance at k</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># make sure that parameter restrictions are satisfied</span></span><br><span class="line">        <span class="keyword">assert</span> b &gt;= <span class="number">0</span>, <span class="string">&#x27;b has to be non-negative&#x27;</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">abs</span>(rho) &lt;= <span class="number">1</span>, <span class="string">&#x27;|rho| has to be smaller than 1&#x27;</span></span><br><span class="line">        <span class="keyword">assert</span> sigma &gt;= <span class="number">0</span>, <span class="string">&#x27;sigma has to be positive&#x27;</span></span><br><span class="line">        <span class="keyword">assert</span> a + b * sigma * sqrt(<span class="number">1</span> - rho ** <span class="number">2</span>) &gt;= <span class="number">0</span>, <span class="string">&#x27;a + b sigma (1-rho^2)^0.5 has to be non-negative&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> a + b * (rho * (k - m) + sqrt(power(k - m, <span class="number">2</span>) + power(sigma, <span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">asymptotes</span>(<span class="params">k, a, b, m, rho</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        raw SVI parameterization left and right asymptotes</span></span><br><span class="line"><span class="string">        :param k:</span></span><br><span class="line"><span class="string">        :param a:</span></span><br><span class="line"><span class="string">        :param b:</span></span><br><span class="line"><span class="string">        :param m:</span></span><br><span class="line"><span class="string">        :param rho:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        left = a - b * (<span class="number">1</span> - rho) * (k - m)</span><br><span class="line">        right = a + b * (<span class="number">1</span> + rho) * (k - m)</span><br><span class="line">        <span class="keyword">return</span> left, right</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">svi_natural</span>(<span class="params">k, delta, mu, rho, omega, zeta</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;natural SVI parameterization</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param k: log-moneyness at which to evaluate the total implied variance</span></span><br><span class="line"><span class="string">        :param delta: level of variance</span></span><br><span class="line"><span class="string">        :param mu: slope of wings</span></span><br><span class="line"><span class="string">        :param rho: translates smile to right</span></span><br><span class="line"><span class="string">        :param omega: counter-clockwise rotation of smile</span></span><br><span class="line"><span class="string">        :param zeta: reduces ATM curvature of the smile</span></span><br><span class="line"><span class="string">        :return: estimated total variance at k</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># make sure that parameter restrictions are satisfied</span></span><br><span class="line">        <span class="keyword">assert</span> omega &gt;= <span class="number">0</span>, <span class="string">&#x27;omega has to be non-negative&#x27;</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">abs</span>(rho) &lt; <span class="number">1</span>, <span class="string">&#x27;|rho| has to be smaller than 1&#x27;</span></span><br><span class="line">        <span class="keyword">assert</span> zeta &gt; <span class="number">0</span>, <span class="string">&#x27;zeta has to be positive&#x27;</span></span><br><span class="line">        <span class="keyword">assert</span> delta + omega * (<span class="number">1</span> - rho ** <span class="number">2</span>) &gt;= <span class="number">0</span>, <span class="string">&#x27;delta + omega (1-rho^2) has to be non-negative&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> delta + omega / <span class="number">2</span> * (<span class="number">1</span> + zeta * rho * (k - mu) + sqrt((zeta * (k - mu) + rho) ** <span class="number">2</span> + (<span class="number">1</span> - rho ** <span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">svi_jump_wing</span>(<span class="params">cls, k, tau, v, psi, p, c, vt</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;jump-wing SVI parameterization</span></span><br><span class="line"><span class="string">        This function implements the jump-wings formulation.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param k: moneyness at which to evaluate the surface</span></span><br><span class="line"><span class="string">        :param tau:</span></span><br><span class="line"><span class="string">        :param v: ATM variance</span></span><br><span class="line"><span class="string">        :param psi: ATM skew</span></span><br><span class="line"><span class="string">        :param p: slope of left/put wing</span></span><br><span class="line"><span class="string">        :param c: slope of right/call wing</span></span><br><span class="line"><span class="string">        :param vt: minimum implied variance</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># make sure that parameter restrictions are satisfied</span></span><br><span class="line">        <span class="keyword">assert</span> v &gt;= <span class="number">0</span>, <span class="string">&#x27;v has to be non-negative&#x27;</span></span><br><span class="line">        <span class="keyword">assert</span> p &gt;= <span class="number">0</span>, <span class="string">&#x27;p has to be non-negative&#x27;</span></span><br><span class="line">        <span class="keyword">assert</span> c &gt;= <span class="number">0</span>, <span class="string">&#x27;c has to be non-negative&#x27;</span></span><br><span class="line">        <span class="keyword">assert</span> vt &gt;= <span class="number">0</span>, <span class="string">&#x27;vt has to be non-negative&#x27;</span></span><br><span class="line"></span><br><span class="line">        a, b, m, rho, sigma = cls.convert_param_from_jump_wing_to_raw(tau, v, psi, p, c, vt)</span><br><span class="line">        <span class="keyword">return</span> cls.svi_raw(k, a, b, m, rho, sigma)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">convert_param_from_raw_to_natural</span>(<span class="params">a, b, m, rho, sigma</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param a:</span></span><br><span class="line"><span class="string">        :param b:</span></span><br><span class="line"><span class="string">        :param m:</span></span><br><span class="line"><span class="string">        :param rho:</span></span><br><span class="line"><span class="string">        :param sigma:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        omega = <span class="number">2</span> * b * sigma / sqrt(<span class="number">1</span> - rho ** <span class="number">2</span>)</span><br><span class="line">        delta = a - omega / <span class="number">2</span> * (<span class="number">1</span> - rho ** <span class="number">2</span>)</span><br><span class="line">        mu = m + rho * sigma / sqrt(<span class="number">1</span> - rho ** <span class="number">2</span>)</span><br><span class="line">        zeta = sqrt(<span class="number">1</span> - rho ** <span class="number">2</span>) / sigma</span><br><span class="line">        <span class="keyword">return</span> delta, mu, rho, omega, zeta</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">convert_param_from_raw_to_jump_wing</span>(<span class="params">tau, a, b, m, rho, sigma</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param tau:</span></span><br><span class="line"><span class="string">        :param a:</span></span><br><span class="line"><span class="string">        :param b:</span></span><br><span class="line"><span class="string">        :param m:</span></span><br><span class="line"><span class="string">        :param rho:</span></span><br><span class="line"><span class="string">        :param sigma:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        w = a + b * (-rho * m + sqrt(m ** <span class="number">2</span> + sigma ** <span class="number">2</span>))</span><br><span class="line">        v = w / tau</span><br><span class="line">        psi = <span class="number">1</span> / sqrt(w) * b / <span class="number">2</span> * (-m / sqrt(m ** <span class="number">2</span> + sigma ** <span class="number">2</span>) + rho)</span><br><span class="line">        p = <span class="number">1</span> / sqrt(w) * b * (<span class="number">1</span> - rho)</span><br><span class="line">        c = <span class="number">1</span> / sqrt(w) * b * (<span class="number">1</span> + rho)</span><br><span class="line">        vt = <span class="number">1</span> / tau * (a + b * sigma * sqrt(<span class="number">1</span> - rho ** <span class="number">2</span>))</span><br><span class="line">        <span class="keyword">return</span> v, psi, p, c, vt</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">convert_param_from_natural_to_raw</span>(<span class="params">delta, mu, rho, omega, zeta</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param delta:</span></span><br><span class="line"><span class="string">        :param mu:</span></span><br><span class="line"><span class="string">        :param rho:</span></span><br><span class="line"><span class="string">        :param omega:</span></span><br><span class="line"><span class="string">        :param zeta:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        a = delta + omega / <span class="number">2</span> * (<span class="number">1</span> - rho ** <span class="number">2</span>)</span><br><span class="line">        b = omega * zeta / <span class="number">2</span></span><br><span class="line">        m = mu - rho / zeta</span><br><span class="line">        sigma = sqrt(<span class="number">1</span> - rho ** <span class="number">2</span>) / zeta</span><br><span class="line">        <span class="keyword">return</span> a, b, m, rho, sigma</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">convert_param_from_jump_wing_to_raw</span>(<span class="params">tau, v, psi, p, c, vt</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param tau:</span></span><br><span class="line"><span class="string">        :param v:</span></span><br><span class="line"><span class="string">        :param psi:</span></span><br><span class="line"><span class="string">        :param p:</span></span><br><span class="line"><span class="string">        :param c:</span></span><br><span class="line"><span class="string">        :param vt:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        w = v * tau</span><br><span class="line"></span><br><span class="line">        b = sqrt(w) / <span class="number">2</span> * (c + p)</span><br><span class="line">        rho = <span class="number">1</span> - p * sqrt(w) / b</span><br><span class="line">        beta = rho - <span class="number">2</span> * psi * sqrt(w) / b</span><br><span class="line">        alpha = sign(beta) * sqrt(<span class="number">1</span> / beta ** <span class="number">2</span> - <span class="number">1</span>)</span><br><span class="line">        m = (v - vt) * tau / (b * (-rho + sign(alpha) * sqrt(<span class="number">1</span> + alpha ** <span class="number">2</span>) - alpha * sqrt(<span class="number">1</span> - rho ** <span class="number">2</span>)))</span><br><span class="line">        <span class="keyword">if</span> m == <span class="number">0</span>:</span><br><span class="line">            sigma = (vt * tau - w) / b / (sqrt(<span class="number">1</span> - rho ** <span class="number">2</span>) - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            sigma = alpha * m</span><br><span class="line">        a = vt * tau - b * sigma * sqrt(<span class="number">1</span> - rho ** <span class="number">2</span>)</span><br><span class="line">        sigma = maximum(sigma, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> a, b, m, rho, sigma</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">convert_param_from_natural_to_jump_wing</span>(<span class="params">cls, tau, delta, mu, rho, omega, zeta</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param tau:</span></span><br><span class="line"><span class="string">        :param delta:</span></span><br><span class="line"><span class="string">        :param mu:</span></span><br><span class="line"><span class="string">        :param rho:</span></span><br><span class="line"><span class="string">        :param omega:</span></span><br><span class="line"><span class="string">        :param zeta:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        a, b, m, rho, sigma = cls.convert_param_from_natural_to_raw(delta, mu, rho, omega, zeta)</span><br><span class="line">        <span class="keyword">return</span> cls.convert_param_from_raw_to_jump_wing(tau, a, b, m, rho, sigma)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">convert_param_from_jump_wing_to_natural</span>(<span class="params">cls, tau, v, psi, p, c, vt</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param tau:</span></span><br><span class="line"><span class="string">        :param v:</span></span><br><span class="line"><span class="string">        :param psi:</span></span><br><span class="line"><span class="string">        :param p:</span></span><br><span class="line"><span class="string">        :param c:</span></span><br><span class="line"><span class="string">        :param vt:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        a, b, m, rho, sigma = cls.convert_param_from_jump_wing_to_raw(tau, v, psi, p, c, vt)</span><br><span class="line">        <span class="keyword">return</span> cls.convert_param_from_raw_to_natural(a, b, m, rho, sigma)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">convert_param_from_surface_to_jump_wing</span>(<span class="params">tau, theta, rho, phi</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param tau:</span></span><br><span class="line"><span class="string">        :param theta:</span></span><br><span class="line"><span class="string">        :param rho:</span></span><br><span class="line"><span class="string">        :param phi:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        v = theta / tau</span><br><span class="line">        psi = <span class="number">0.5</span> * rho * sqrt(theta) * phi</span><br><span class="line">        p = <span class="number">0.5</span> * sqrt(theta) * phi * (<span class="number">1</span> - rho)</span><br><span class="line">        c = p + <span class="number">2</span> * psi</span><br><span class="line">        vt = v * (<span class="number">4</span> * p * c) / ((p + c) ** <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">return</span> v, psi, p, c, vt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SVI</span>(<span class="params">BaseSVI</span>):</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loss</span>(<span class="params">tiv: ndarray, vega: ndarray, y: ndarray, c: <span class="built_in">float</span>, d: <span class="built_in">float</span>, a: <span class="built_in">float</span></span>) -&gt; <span class="built_in">float</span>:</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;object function</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param tiv: total implied variance</span></span><br><span class="line"><span class="string">        :param vega:</span></span><br><span class="line"><span class="string">        :param y:</span></span><br><span class="line"><span class="string">        :param c:</span></span><br><span class="line"><span class="string">        :param d:</span></span><br><span class="line"><span class="string">        :param a:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        diff = tiv - (a + d * y + c * sqrt(y * y + <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> (vega * diff * diff).mean()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">acceptable</span>(<span class="params">tiv: ndarray, sigma: <span class="built_in">float</span>, c: <span class="built_in">float</span>, d: <span class="built_in">float</span>, a: <span class="built_in">float</span></span>) -&gt; <span class="built_in">bool</span>:</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;convex domain (a parallelepipedon), parameter boundary check</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param tiv:total implied variance</span></span><br><span class="line"><span class="string">        :param sigma:</span></span><br><span class="line"><span class="string">        :param c: b * sigma * T</span></span><br><span class="line"><span class="string">        :param d: rho * b * sigma * T</span></span><br><span class="line"><span class="string">        :param a: a * T</span></span><br><span class="line"><span class="string">        :param eps: float extreme limit</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        eps = sys.float_info.epsilon</span><br><span class="line">        con1 = -eps &lt; c &lt; <span class="number">4</span> * sigma + eps</span><br><span class="line">        con2 = <span class="built_in">abs</span>(d) - eps &lt; minimum(c, <span class="number">4</span> * sigma - c) + eps</span><br><span class="line">        con3 = -eps &lt; a &lt; minimum(tiv.<span class="built_in">max</span>(), <span class="number">1e6</span>) + eps</span><br><span class="line">        <span class="keyword">return</span> con1 <span class="keyword">and</span> con2 <span class="keyword">and</span> con3</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">calibration</span>(<span class="params">cls, tiv: ndarray, vega: ndarray, k: ndarray, m: <span class="built_in">float</span>, sigma: <span class="built_in">float</span></span>) -&gt; [<span class="built_in">float</span>, <span class="built_in">float</span>, <span class="built_in">float</span>,</span></span><br><span class="line"><span class="function">                                                                                              <span class="built_in">float</span>]:</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Quasi-Explicit Calibration of Gatheral’s SVI model</span></span><br><span class="line"><span class="string">        Step 1. find the global minimizer of f, solving the linear system ∇f = 0. If the output belongs to D, then stop;</span></span><br><span class="line"><span class="string">        Step 2. if Step 1 yields a global minimum outside D, then look for min partial Df.</span></span><br><span class="line"><span class="string">        :param tiv:</span></span><br><span class="line"><span class="string">        :param vega:</span></span><br><span class="line"><span class="string">        :param k:</span></span><br><span class="line"><span class="string">        :param m:</span></span><br><span class="line"><span class="string">        :param sigma:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        vega /= vega.<span class="built_in">max</span>()  <span class="comment"># winsorize</span></span><br><span class="line">        w = vega.mean()  <span class="comment"># weight replace n, n = tiv.shape[0]</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># scale</span></span><br><span class="line">        y = (k - m) / sigma</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2020-04-10 sum -&gt; mean 消除batch-size 数量级对epsilon影响,</span></span><br><span class="line">        <span class="comment"># vega adjusted the weight of tail contracts in loss function</span></span><br><span class="line">        y1 = (vega * y).mean()</span><br><span class="line">        y2 = (vega * y * y).mean()</span><br><span class="line">        y3 = (vega * sqrt(y * y + <span class="number">1</span>)).mean()</span><br><span class="line">        y4 = (vega * y * sqrt(y * y + <span class="number">1</span>)).mean()</span><br><span class="line">        y5 = (vega * (y * y + <span class="number">1</span>)).mean()</span><br><span class="line"></span><br><span class="line">        vy2 = (vega * tiv * sqrt(y * y + <span class="number">1</span>)).mean()</span><br><span class="line">        vy = (vega * tiv * y).mean()</span><br><span class="line">        v = (vega * tiv).mean()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Step 1. find the global minimizer of f, solving the linear system ∇f = 0. If the output belongs to D, then stop;</span></span><br><span class="line">        matrix = [</span><br><span class="line">            [y5, y4, y3],</span><br><span class="line">            [y4, y2, y1],</span><br><span class="line">            [y3, y1, w]</span><br><span class="line">        ]</span><br><span class="line">        vector = [vy2, vy, v]</span><br><span class="line">        c, d, a, = solve(array(matrix), array(vector))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># check if parameters in free-arbitrage constraints</span></span><br><span class="line">        <span class="keyword">if</span> cls.acceptable(tiv, sigma, c, d, a):</span><br><span class="line">            loss = cls.loss(tiv, vega, y, c, d, a)</span><br><span class="line">            <span class="keyword">return</span> c, d, a, loss</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Step 2. if Step 1 yields a global minimum outside D, then look for min partial Df.</span></span><br><span class="line">        matrix_list = []</span><br><span class="line">        vector_list = []</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Finds the solutions for which one of the three parameters is at its bounds</span></span><br><span class="line">        <span class="comment"># system for a = 0</span></span><br><span class="line">        matrix = [</span><br><span class="line">            [y5, y4, y3],</span><br><span class="line">            [y4, y2, y1],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]</span><br><span class="line">        ]</span><br><span class="line">        vector = [vy2, vy, <span class="number">0</span>]</span><br><span class="line">        matrix_list.append(matrix)</span><br><span class="line">        vector_list.append(vector)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># system for a = max of total implied variance</span></span><br><span class="line">        <span class="comment"># note the optimal fit cannot be systematically greater than the largest observed variance.</span></span><br><span class="line">        matrix = [</span><br><span class="line">            [y5, y4, y3],</span><br><span class="line">            [y4, y2, y1],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]</span><br><span class="line">        ]</span><br><span class="line">        vector = [vy2, vy, tiv.<span class="built_in">max</span>()]</span><br><span class="line">        matrix_list.append(matrix)</span><br><span class="line">        vector_list.append(vector)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># system for d = c or d = -c =&gt; c+d=0 c-d=0</span></span><br><span class="line">        matrix = [</span><br><span class="line">            [y5, y4, y3],</span><br><span class="line">            [<span class="number">1</span>, -<span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">            [y3, y1, w]</span><br><span class="line">        ]</span><br><span class="line">        vector = [vy2, <span class="number">0</span>, v]</span><br><span class="line">        matrix_list.append(matrix)</span><br><span class="line">        vector_list.append(vector)</span><br><span class="line"></span><br><span class="line">        matrix = [</span><br><span class="line">            [y5, y4, y3],</span><br><span class="line">            [<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">            [y3, y1, w]</span><br><span class="line">        ]</span><br><span class="line">        vector = [vy2, <span class="number">0</span>, v]</span><br><span class="line">        matrix_list.append(matrix)</span><br><span class="line">        vector_list.append(vector)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># system part for |d| = 4*sigma-c =&gt; |d| + c = 4 * sigma</span></span><br><span class="line">        matrix = [</span><br><span class="line">            [y5, y4, y3],</span><br><span class="line">            [<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">            [y3, y1, w]</span><br><span class="line">        ]</span><br><span class="line">        vector = [vy2, <span class="number">4</span> * sigma, v]</span><br><span class="line">        matrix_list.append(matrix)</span><br><span class="line">        vector_list.append(vector)</span><br><span class="line"></span><br><span class="line">        matrix = [</span><br><span class="line">            [y5, y4, y3],</span><br><span class="line">            [<span class="number">1</span>, -<span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">            [y3, y1, w]</span><br><span class="line">        ]</span><br><span class="line">        vector = [vy2, <span class="number">4</span> * sigma, v]</span><br><span class="line">        matrix_list.append(matrix)</span><br><span class="line">        vector_list.append(vector)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># # system for c = 0</span></span><br><span class="line">        <span class="comment"># matrix = [</span></span><br><span class="line">        <span class="comment">#     [1, 0, 0],</span></span><br><span class="line">        <span class="comment">#     [y4, y2, y1],</span></span><br><span class="line">        <span class="comment">#     [y3, y1, w]</span></span><br><span class="line">        <span class="comment"># ]</span></span><br><span class="line">        <span class="comment"># vector = [0, vy, v]</span></span><br><span class="line">        <span class="comment"># matrix_list.append(matrix)</span></span><br><span class="line">        <span class="comment"># vector_list.append(vector)</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># # system for c = 4*sigma</span></span><br><span class="line">        <span class="comment"># matrix = [</span></span><br><span class="line">        <span class="comment">#     [1, 0, 0],</span></span><br><span class="line">        <span class="comment">#     [y4, y2, y1],</span></span><br><span class="line">        <span class="comment">#     [y3, y1, w]</span></span><br><span class="line">        <span class="comment"># ]</span></span><br><span class="line">        <span class="comment"># vector = [4*sigma, vy, v]</span></span><br><span class="line">        <span class="comment"># matrix_list.append(matrix)</span></span><br><span class="line">        <span class="comment"># vector_list.append(vector)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Finds the solution for which two of the three parameters are at its bounds.</span></span><br><span class="line">        <span class="comment"># The Zeliade whitepaper speaks about doing one-dimensinal search to find the minimum,</span></span><br><span class="line">        <span class="comment"># but since fixing 2 out of the three parameters just leads to a quadratic equation in the third,</span></span><br><span class="line">        <span class="comment"># finding the global minimum and then cutting it off if it falls outside the  valid boundaries, works.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># c = 0, implies d = 0, find optimal a</span></span><br><span class="line">        matrix = [</span><br><span class="line">            [<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">            [y3, y1, w]</span><br><span class="line">        ]</span><br><span class="line">        vector = [<span class="number">0</span>, <span class="number">0</span>, v]</span><br><span class="line">        matrix_list.append(matrix)</span><br><span class="line">        vector_list.append(vector)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># c = 4*sigma, implied d = 0, find optimal a</span></span><br><span class="line">        matrix = [</span><br><span class="line">            [<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">            [y3, y1, w]</span><br><span class="line">        ]</span><br><span class="line">        vector = [<span class="number">4</span> * sigma, <span class="number">0</span>, v]</span><br><span class="line">        matrix_list.append(matrix)</span><br><span class="line">        vector_list.append(vector)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># a = 0, d = c, find optimal c</span></span><br><span class="line">        matrix = [</span><br><span class="line">            [y5, y4, y3],</span><br><span class="line">            [<span class="number">1</span>, -<span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]</span><br><span class="line">        ]</span><br><span class="line">        vector = [vy2, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">        matrix_list.append(matrix)</span><br><span class="line">        vector_list.append(vector)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># a = 0, d = -c, find optimal c</span></span><br><span class="line">        matrix = [</span><br><span class="line">            [y5, y4, y3],</span><br><span class="line">            [<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]</span><br><span class="line">        ]</span><br><span class="line">        vector = [vy2, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">        matrix_list.append(matrix)</span><br><span class="line">        vector_list.append(vector)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># a = 0, d = 4*sigma-c, find optimal c =&gt; d+c=4*sigma</span></span><br><span class="line">        matrix = [</span><br><span class="line">            [y5, y4, y3],</span><br><span class="line">            [<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]</span><br><span class="line">        ]</span><br><span class="line">        vector = [vy2, <span class="number">4</span> * sigma, <span class="number">0</span>]</span><br><span class="line">        matrix_list.append(matrix)</span><br><span class="line">        vector_list.append(vector)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># a = 0, d = c-4s, find optimal c =&gt; c-d = 4*sigma</span></span><br><span class="line">        matrix = [</span><br><span class="line">            [y5, y4, y3],</span><br><span class="line">            [<span class="number">1</span>, -<span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]</span><br><span class="line">        ]</span><br><span class="line">        vector = [vy2, <span class="number">4</span> * sigma, <span class="number">0</span>]</span><br><span class="line">        matrix_list.append(matrix)</span><br><span class="line">        vector_list.append(vector)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># optimizer, solve</span></span><br><span class="line">        params = []</span><br><span class="line">        <span class="keyword">for</span> matrix, vector <span class="keyword">in</span> <span class="built_in">zip</span>(matrix_list, vector_list):</span><br><span class="line">            c, d, a = solve(array(matrix), array(vector))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># clip make params in convex domain</span></span><br><span class="line">            c = clip(c, <span class="number">0</span>, maximum(<span class="number">0</span>, <span class="number">4</span> * sigma))</span><br><span class="line">            a = clip(a, <span class="number">0</span>, maximum(tiv.<span class="built_in">max</span>(), <span class="number">0</span>))</span><br><span class="line">            d_ub = minimum(maximum(c, <span class="number">0</span>), maximum(<span class="number">4</span> * sigma - c, <span class="number">0</span>))</span><br><span class="line">            d_lb = maximum(-maximum(c, <span class="number">0</span>), -maximum(<span class="number">4</span> * sigma - c, <span class="number">0</span>))</span><br><span class="line">            d = clip(d, d_lb, d_ub)</span><br><span class="line"></span><br><span class="line">            loss = cls.loss(tiv, vega, y, c, d, a)</span><br><span class="line">            <span class="keyword">if</span> cls.acceptable(tiv, sigma, c, d, a):</span><br><span class="line">                params.append([c, d, a, loss])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理sigma 值为负数的情况</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(params) == <span class="number">0</span>:</span><br><span class="line">            loss = maximum(nan_to_num(loss), <span class="number">1e-6</span>) * <span class="number">1e6</span></span><br><span class="line">            <span class="keyword">return</span> c, d, a, loss</span><br><span class="line"></span><br><span class="line">        params = array(params)</span><br><span class="line">        min_idx = argmin(params[:, -<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">return</span> params[min_idx]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_score</span>(<span class="params">cls, param: <span class="built_in">tuple</span>, tiv: ndarray, vega: ndarray, k: ndarray</span>) -&gt; <span class="built_in">float</span>:</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param param: sigma, m</span></span><br><span class="line"><span class="string">        :param tiv:</span></span><br><span class="line"><span class="string">        :param vega:</span></span><br><span class="line"><span class="string">        :param k:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        (sigma, m) = param</span><br><span class="line">        <span class="keyword">return</span> cls.calibration(tiv, vega, k, m, sigma)[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fit</span>(<span class="params">cls, tiv: ndarray, vega: ndarray, k: ndarray, tau: <span class="built_in">float</span> = <span class="literal">None</span>, m: <span class="built_in">float</span> = <span class="number">0</span>, sigma: <span class="built_in">float</span> = <span class="number">0.1</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            epsilon: <span class="built_in">float</span> = <span class="number">1e-16</span></span>) -&gt; [<span class="built_in">float</span>, <span class="built_in">float</span>, <span class="built_in">float</span>, <span class="built_in">float</span>, <span class="built_in">float</span>]:</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;implied total variance if tau is None, else implied variance.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param tiv: total implied variance, iv * iv * t</span></span><br><span class="line"><span class="string">        :param vega:</span></span><br><span class="line"><span class="string">        :param k: moneyness</span></span><br><span class="line"><span class="string">        :param tau: time to expiry</span></span><br><span class="line"><span class="string">        :param m:</span></span><br><span class="line"><span class="string">        :param sigma:</span></span><br><span class="line"><span class="string">        :param epsilon:</span></span><br><span class="line"><span class="string">        :return: svi_demo params to generate implied total variance if tau is None, else implied variance.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> tau <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            tau = <span class="number">1.</span></span><br><span class="line"></span><br><span class="line">        residual = minimize(cls._score, array([sigma, m]), args=(tiv, vega, k),</span><br><span class="line">                            bounds=[(<span class="number">0.001</span>, <span class="literal">None</span>), (<span class="literal">None</span>, <span class="literal">None</span>)], tol=epsilon,</span><br><span class="line">                            method=<span class="string">&quot;Nelder-Mead&quot;</span>)</span><br><span class="line">        <span class="keyword">assert</span> residual.success</span><br><span class="line">        sigma, m = residual.x</span><br><span class="line"></span><br><span class="line">        c, d, a, loss = cls.calibration(tiv, vega, k, m, sigma)</span><br><span class="line">        <span class="keyword">if</span> c != <span class="number">0</span>:</span><br><span class="line">            a, rho, b = a / tau, d / c, c / (sigma * tau)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            a, rho, b = a / tau, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> tau &gt;= <span class="number">0</span> <span class="keyword">and</span> sigma &gt;= <span class="number">0</span> <span class="keyword">and</span> <span class="built_in">abs</span>(rho) &lt;= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">round</span>([a, b, m, rho, sigma], <span class="number">4</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>稻草人
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://dybeta2021.github.io/2021/07/13/svi/" title="Stochastic Volatility Inspired">https://dybeta2021.github.io/2021/07/13/svi/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ivs/" rel="tag"># ivs</a>
              <a href="/tags/svi/" rel="tag"># svi</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/07/09/hft/" rel="prev" title="以C++为核心语言的高频交易系统是如何做到低延迟的">
      <i class="fa fa-chevron-left"></i> 以C++为核心语言的高频交易系统是如何做到低延迟的
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/07/24/holding-option/" rel="next" title="通过蒙特卡洛模拟估算期权的持有成本">
      通过蒙特卡洛模拟估算期权的持有成本 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#the-svi-parameterization"><span class="nav-number">1.</span> <span class="nav-text">The SVI parameterization</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#slopes-and-minimum"><span class="nav-number">2.</span> <span class="nav-text">Slopes and minimum</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#arbitrage-free-conditions"><span class="nav-number">3.</span> <span class="nav-text">Arbitrage-Free Conditions</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#vertical-spread-arbitrage-free"><span class="nav-number">3.1.</span> <span class="nav-text">Vertical Spread
Arbitrage-Free</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#calendar-spread-arbitrage-free"><span class="nav-number">3.2.</span> <span class="nav-text">Calendar Spread
Arbitrage-Free</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#quasi-explicit-calibration"><span class="nav-number">4.</span> <span class="nav-text">Quasi-Explicit Calibration</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A2%AF%E5%BA%A6%E4%B8%8B%E9%99%8D%E6%B3%95%E5%B1%95%E5%BC%80"><span class="nav-number">4.1.</span> <span class="nav-text">梯度下降法展开</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#the-svi-jump-wings-svi-jw-parameterization"><span class="nav-number">5.</span> <span class="nav-text">The SVI Jump-Wings
(SVI-JW) parameterization</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#reference"><span class="nav-number">6.</span> <span class="nav-text">Reference</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#quasi-explicit-calibration-code"><span class="nav-number">7.</span> <span class="nav-text">Quasi-Explicit Calibration
Code</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">稻草人</p>
  <div class="site-description" itemprop="description">风物长宜放眼量</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">67</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">61</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/dybeta2021" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;dybeta2021" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:dybeta2021@163.com" title="E-Mail → mailto:dybeta2021@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">稻草人</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>
博客全站共294.5k字
        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>




  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
